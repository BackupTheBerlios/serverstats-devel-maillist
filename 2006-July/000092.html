<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Serverstats-devel] r140 - in trunk: . config.sample includes
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/serverstats-devel/2006-July/index.html" >
   <LINK REL="made" HREF="mailto:serverstats-devel%40lists.berlios.de?Subject=Re%3A%20%5BServerstats-devel%5D%20r140%20-%20in%20trunk%3A%20.%20config.sample%20includes&In-Reply-To=%3C200607031113.k63BDXvO022384%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000086.html">
   <LINK REL="Next"  HREF="000093.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Serverstats-devel] r140 - in trunk: . config.sample includes</H1>
    <B>goliath at berlios.de</B> 
    <A HREF="mailto:serverstats-devel%40lists.berlios.de?Subject=Re%3A%20%5BServerstats-devel%5D%20r140%20-%20in%20trunk%3A%20.%20config.sample%20includes&In-Reply-To=%3C200607031113.k63BDXvO022384%40sheep.berlios.de%3E"
       TITLE="[Serverstats-devel] r140 - in trunk: . config.sample includes">goliath at berlios.de
       </A><BR>
    <I>Mon Jul  3 13:13:33 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000086.html">[Serverstats-devel] r139 - in branches/xmlconfig: . test
</A></li>
        <LI>Next message: <A HREF="000093.html">[Serverstats-devel] r141 - in trunk: . lang
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#92">[ date ]</a>
              <a href="thread.html#92">[ thread ]</a>
              <a href="subject.html#92">[ subject ]</a>
              <a href="author.html#92">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: goliath
Date: 2006-07-03 13:13:28 +0200 (Mon, 03 Jul 2006)
New Revision: 140

Modified:
   trunk/config.sample/graph.php
   trunk/includes/functions.php
   trunk/includes/simpleconfig.class.php
   trunk/index.php
   trunk/style.css
Log:
 * added tree-view (graphs with categories and tree with set of filters
 * htmlspecialchars for all lang::t()-calls


Modified: trunk/config.sample/graph.php
===================================================================
--- trunk/config.sample/graph.php	2006-07-03 09:36:36 UTC (rev 139)
+++ trunk/config.sample/graph.php	2006-07-03 11:13:28 UTC (rev 140)
@@ -35,6 +35,17 @@
 // (To change what graphs are generated by simpleconfig please edit simple.php)
 simpleconfig::graph($config, $rootConfig['simple']);
 
+$config['tree'] = array(
+	'title' =&gt; 'All Graphs',
+	'filter' =&gt; '',
+	'sub' =&gt; array(
+		array(
+			'title' =&gt; 'localhost',
+			'filter' =&gt; 'host:localhost'
+		)
+	)
+);
+
 // Add own graphs (examples, like those used in the simple-config)
 /*
 $config['list'][] = array(

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2006-07-03 09:36:36 UTC (rev 139)
+++ trunk/includes/functions.php	2006-07-03 11:13:28 UTC (rev 140)
@@ -36,23 +36,53 @@
 	}
 }
 
+function menuTree($tree, $path = '')
+{
+	?&gt;
+	&lt;ul&gt;
+	&lt;?php
+	foreach ($tree as $index =&gt; $item)
+	{
+		$itempath = $path . ($path === &quot;&quot; ? $index : &quot;,$index&quot;);
+		?&gt;
+		&lt;li class=&quot;treeitem&quot;&gt;
+			&lt;a href=&quot;index.php?tree=&lt;?php echo htmlspecialchars($itempath); ?&gt;&quot;&gt;&lt;?php echo htmlspecialchars($item['title']); ?&gt;&lt;/a&gt;
+			&lt;?php if (isset($item['sub'])) menuTree($item['sub'], $itempath); ?&gt;
+		&lt;/li&gt;
+		&lt;?php
+	}
+	?&gt;
+	&lt;/ul&gt;
+	&lt;?php
+}
+
 // Function to  draw the menu
 function menu()
 {
-	global $config;
-	if (!isset($config) || !isset($config['graph']['list']))
+	global $config, $filter;
+	if (!isset($config) || !isset($config['graph']['list']) || !isset($config['graph']['tree']))
 	{
 		return;
 	}
 	?&gt;&lt;div id=&quot;menu&quot;&gt;
+	&lt;h2&gt;&lt;?php echo htmlspecialchars(lang::t('Tree')); ?&gt;&lt;/h2&gt;
 	&lt;ul&gt;
-	&lt;li class=&quot;index&quot;&gt;&lt;a href=&quot;index.php&quot;&gt;&lt;?php echo lang::t('Summary'); ?&gt;&lt;/a&gt;&lt;/li&gt;
+	&lt;li class=&quot;index&quot;&gt;
+		&lt;a href=&quot;index.php&quot;&gt;&lt;?php echo htmlspecialchars($config['graph']['tree']['title']); ?&gt;&lt;/a&gt;
+		&lt;?php if (isset($config['graph']['tree']['sub'])) menuTree($config['graph']['tree']['sub']); ?&gt;
+	&lt;/li&gt;
+	&lt;/ul&gt;
+	&lt;h2&gt;&lt;?php echo htmlspecialchars(lang::t('Graphs')); ?&gt;&lt;/h2&gt;
+	&lt;ul&gt;
+	&lt;li class=&quot;index&quot;&gt;&lt;a href=&quot;index.php&quot;&gt;&lt;?php echo htmlspecialchars(lang::t('Summary')); ?&gt;&lt;/a&gt;&lt;/li&gt;
 	&lt;?php
 	foreach ($config['graph']['list'] as $graphindex =&gt; $graph)
 	{
+		if (isFiltered($graph, $filter))
+			continue;
 		?&gt;
 		&lt;li class=&quot;detail&quot;&gt;
-			&lt;a href=&quot;detail.php?graph=&lt;?php echo $graphindex; ?&gt;&quot;&gt;&lt;?php echo htmlspecialchars($graph['title']); ?&gt;&lt;/a&gt;
+			&lt;a href=&quot;detail.php?graph=&lt;?php echo htmlspecialchars($graphindex); ?&gt;&quot;&gt;&lt;?php echo htmlspecialchars($graph['title']); ?&gt;&lt;/a&gt;
 		&lt;/li&gt;
 		&lt;?php
 	}
@@ -114,4 +144,101 @@
 	}
 }
 
+function extractFilter($filter)
+{
+	$filters = array();
+	$filterParts = preg_split('/\s*,\s*/', trim($filter));
+	foreach ($filterParts as $filterPart)
+	{
+		if (preg_match('/^([a-zA-Z0-9]+):(.+)$/', $filterPart, $matches))
+		{
+			$filters[$matches[1]] = $matches[2];
+		}
+	}
+	return $filters;
+}
+
+function extractFilterFromTree($tree)
+{
+	$last = array_pop($tree);
+	return extractFilter($last['filter']);
+}
+
+function extractTree($treeString = '')
+{
+	global $config;
+	$tree = array();
+	$treeString = trim($treeString);
+	if ($treeString === &quot;&quot;)
+		$treeParts = array();
+	else
+		$treeParts = preg_split('/\s*,\s*/', $treeString);
+	$path = '';
+	$tree[] = array(
+		'title' =&gt; $config['graph']['tree']['title'],
+		'filter' =&gt; $config['graph']['tree']['filter'],
+		'path' =&gt; $path
+	);
+	$subTree = $config['graph']['tree']['sub'];
+	foreach ($treeParts as $part)
+	{
+		if (isset($subTree[$part]))
+		{
+			$path .= $path === &quot;&quot; ? $part : &quot;,$part&quot;;
+			$tree[] = array(
+				'title' =&gt; $subTree[$part]['title'],
+				'filter' =&gt; $subTree[$part]['filter'],
+				'path' =&gt; $path
+			);
+			if (isset($subTree[$part]['sub']))
+				$subTree = $subTree[$part]['sub'];
+			else
+				break;
+		}
+		else
+			break;
+	}
+	return $tree;
+}
+
+function isFiltered($graph, $filter)
+{
+	foreach ($filter as $category =&gt; $condition)
+	{
+		if (!isset($graph['categories'][$category]))
+			return true;
+		if ($graph['categories'][$category] instanceof ArrayAccess)
+		{
+			$filtered = true;
+			foreach ($graph['categories'][$category] as $value)
+			{
+				if ($condition == $value)
+				{
+					$filtered = false;
+					break;
+				}
+			}
+			if ($filtered)
+				return true;
+		}
+		else
+		{
+			if ($condition != $graph['categories'][$category])
+				return true;
+		}
+	}
+}
+
+function printBreadcrumps($tree)
+{
+	$needSep = false;
+	foreach ($tree as $crump)
+	{
+		?&gt;
+		&lt;?php if ($needSep) echo ' &gt; '; ?&gt;&lt;a href=&quot;index.php?tree=&lt;?php echo htmlspecialchars($crump['path']); ?&gt;&quot;&gt;&lt;?php echo htmlspecialchars($crump['title']); ?&gt;&lt;/a&gt;
+		&lt;?php
+		$needSep = true;
+	}
+}
+
 ?&gt;

Modified: trunk/includes/simpleconfig.class.php
===================================================================
--- trunk/includes/simpleconfig.class.php	2006-07-03 09:36:36 UTC (rev 139)
+++ trunk/includes/simpleconfig.class.php	2006-07-03 11:13:28 UTC (rev 140)
@@ -55,6 +55,7 @@
 										'title' =&gt; sprintf($graphconf['title'], $host),
 										'lowerLimit' =&gt; 0,
 										'altAutoscaleMax' =&gt; true,
+										'categories' =&gt; array('host' =&gt; $host),
 										'content' =&gt; array(
 											array(
 												'type' =&gt; 'LINE',
@@ -86,6 +87,7 @@
 									'upperLimit' =&gt; 100,
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; 'localhost'),
 									'content' =&gt; array(
 										array(
 											'type' =&gt; 'AREA',
@@ -172,6 +174,7 @@
 										'lowerLimit' =&gt; 0,
 										'altAutoscaleMax' =&gt; true,
 										'verticalLabel' =&gt; 'byte/s',
+										'categories' =&gt; array('host' =&gt; 'localhost'),
 										'content' =&gt; array(
 											array(
 												'type' =&gt; 'LINE',
@@ -210,6 +213,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; 'localhost'),
 									'content' =&gt; array(
 										array(
 											'type' =&gt; 'COMMENT',
@@ -322,6 +326,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; 'localhost'),
 									'content' =&gt; array(
 										array(
 											'type' =&gt; 'AREA',
@@ -359,6 +364,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; 'localhost'),
 									'content' =&gt; array(
 										array(
 											'type' =&gt; 'DEF',
@@ -482,6 +488,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; 'localhost'),
 									'content' =&gt; array(
 										array(
 											'type' =&gt; 'DEF',
@@ -617,6 +624,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; $modconf['host']),
 									'content' =&gt; array(
 										array(
 											'type' =&gt; 'LINE',
@@ -635,6 +643,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; $modconf['host']),
 									'content' =&gt; array(
 										array(
 											'type' =&gt; 'AREA',
@@ -666,6 +675,7 @@
 										'title' =&gt; sprintf($graphconf['title'], $host),
 										'lowerLimit' =&gt; 0,
 										'altAutoscaleMax' =&gt; true,
+										'categories' =&gt; array('host' =&gt; $host),
 										'content' =&gt; array(
 											array(
 												'type' =&gt; 'LINE',
@@ -707,6 +717,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; $modconf['hosts']),
 									'content' =&gt; $content
 								);
 								break;
@@ -729,6 +740,7 @@
 										'title' =&gt; sprintf($graphconf['title'], $host),
 										'lowerLimit' =&gt; 0,
 										'altAutoscaleMax' =&gt; true,
+										'categories' =&gt; array('host' =&gt; $host),
 										'content' =&gt; array(
 											array(
 												'type' =&gt; 'AREA',
@@ -805,6 +817,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; $modconf['hosts']),
 									'content' =&gt; $content
 								);
 								break;
@@ -827,6 +840,7 @@
 										'title' =&gt; sprintf($graphconf['title'], $chain),
 										'lowerLimit' =&gt; 0,
 										'altAutoscaleMax' =&gt; true,
+										'categories' =&gt; array('host' =&gt; 'localhost'),
 										'content' =&gt; array(
 											array(
 												'type' =&gt; 'LINE',
@@ -844,6 +858,7 @@
 										'title' =&gt; sprintf($graphconf['title'], $chain),
 										'lowerLimit' =&gt; 0,
 										'altAutoscaleMax' =&gt; true,
+										'categories' =&gt; array('host' =&gt; 'localhost'),
 										'content' =&gt; array(
 											array(
 												'type' =&gt; 'LINE',
@@ -885,6 +900,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; 'localhost'),
 									'content' =&gt; $content
 								);
 								break;
@@ -906,6 +922,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; 'localhost'),
 									'content' =&gt; $content
 								);
 								break;
@@ -928,6 +945,7 @@
 										'title' =&gt; sprintf($graphconf['title'], $interface),
 										'lowerLimit' =&gt; 0,
 										'altAutoscaleMax' =&gt; true,
+										'categories' =&gt; array('host' =&gt; 'localhost'),
 										'content' =&gt; array(
 											array(
 												'type' =&gt; 'LINE',
@@ -985,6 +1003,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; 'localhost'),
 									'content' =&gt; $content
 								);
 								break;
@@ -1005,6 +1024,7 @@
 									'title' =&gt; $graphconf['title'],
 									'lowerLimit' =&gt; 0,
 									'altAutoscaleMax' =&gt; true,
+									'categories' =&gt; array('host' =&gt; 'localhost'),
 									'content' =&gt; array(
 										array(
 											'type' =&gt; 'AREA',

Modified: trunk/index.php
===================================================================
--- trunk/index.php	2006-07-03 09:36:36 UTC (rev 139)
+++ trunk/index.php	2006-07-03 11:13:28 UTC (rev 140)
@@ -29,22 +29,40 @@
 ?&gt;&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</A>&quot;&gt; 
 &lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot; xml:lang=&quot;de&quot;&gt;  
 &lt;head&gt;
-	&lt;title&gt;&lt;?php echo lang::t('Statistics'); ?&gt; - &lt;?php echo lang::t('Summary'); ?&gt;&lt;/title&gt;
+	&lt;title&gt;&lt;?php echo htmlspecialchars(lang::t('Statistics')); ?&gt; - &lt;?php echo htmlspecialchars(lang::t('Summary')); ?&gt;&lt;/title&gt;
 	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;
 	&lt;link rel=&quot;stylesheet&quot; href=&quot;style.css&quot; type=&quot;text/css&quot; media=&quot;screen, projection&quot; /&gt;
 &lt;/head&gt;
 &lt;body class=&quot;index&quot;&gt;
 &lt;?php
 
+if (isset($_GET['tree']))
+{
+	$tree = extractTree($_GET['tree']);
+	$filter = extractFilterFromTree($tree);
+}
+elseif (isset($_GET['filter']))
+{
+	$tree = extractTree();
+	$filter = extractFilter($_GET['filter']);
+}
+else
+{
+	$tree = extractTree();
+	$filter = array();
+}
+
 // Show the menu
 menu();
 
 ?&gt;
-&lt;h1&gt;&lt;?php echo lang::t('Statistics'); ?&gt; - &lt;?php echo lang::t('Summary'); ?&gt;&lt;/h1&gt;
+&lt;h1&gt;&lt;?php echo htmlspecialchars(lang::t('Statistics')); ?&gt; - &lt;?php echo htmlspecialchars(lang::t('Summary')); ?&gt;: &lt;?php printBreadcrumps($tree); ?&gt;&lt;/h1&gt;
 &lt;?php
 
 foreach ($config['graph']['list'] as $graphindex =&gt; $graph)
 {
+	if (isFiltered($graph, $filter))
+		continue;
 	?&gt;
 	&lt;h2&gt;&lt;?php echo htmlspecialchars($graph['title']); ?&gt;&lt;/h2&gt;
 	&lt;a href=&quot;detail.php?graph=&lt;?php echo $graphindex; ?&gt;&quot;&gt;

Modified: trunk/style.css
===================================================================
--- trunk/style.css	2006-07-03 09:36:36 UTC (rev 139)
+++ trunk/style.css	2006-07-03 11:13:28 UTC (rev 140)
@@ -65,6 +65,10 @@
 	white-space: nowrap;
 }
 
+#menu .treeitem {
+	padding-left: 10px;
+}
+
 html &gt; body #menu li {
 	display: block;
 	padding-right: 0px;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000086.html">[Serverstats-devel] r139 - in branches/xmlconfig: . test
</A></li>
	<LI>Next message: <A HREF="000093.html">[Serverstats-devel] r141 - in trunk: . lang
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#92">[ date ]</a>
              <a href="thread.html#92">[ thread ]</a>
              <a href="subject.html#92">[ subject ]</a>
              <a href="author.html#92">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/serverstats-devel">More information about the Serverstats-devel
mailing list</a><br>
</body></html>
